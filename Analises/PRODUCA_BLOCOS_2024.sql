-- D4 BLOCOS EMPENHADOS PARA AS MÁQUINAS JA PRODUZIDAS EM 2024------------------------------------

WITH MAQ_2024(OP, ANO, MES) AS 
(
	SELECT   --ORDEM DE PRODUÇÃO DE TODAS AS MÁQUINAS FATURADAS EM 2024-------------
		C2_NUM
		, YEAR(C2_DATRF) AS ANO
		, MONTH(C2_DATRF) AS MES
	
		FROM
			SC2010
			INNER JOIN SB1010 ON C2_PRODUTO = B1_COD AND B1_GRUPO ='1000' AND SB1010.D_E_L_E_T_<> '*'
		WHERE 
			C2_DATRF LIKE '202%'
),

BLOCOS_2024 (PRODUTO, GRUPO, DESCR, COMP, QNT_EMP, GR_COMP, NUM_OP, ANO, MES)AS 
(	
	SELECT	 --BLOCOS EMPENHADOS DE TODAS AS MÁQUINAS FATURADAS NO ANO-------------				
		D4_COD,
		GR1.B1_GRUPO AS Grupo,
		GR1.B1_DESC,
		G1_COMP,
		D4_QTDEORI AS QNT_EMP,
		GR2.B1_GRUPO AS GRUPO_COMP,
		LEFT (D4_OP, LEN(D4_OP)-5) AS NUMERO_OP,
		ANO,
		MES

		FROM SD4010 D 

		INNER JOIN MAQ_2024 ON OP = LEFT (D4_OP, LEN(D4_OP)-5)

		INNER JOIN SB1010 GR1 ON D4_COD = B1_COD AND GR1.D_E_L_E_T_ <> '*'

		INNER JOIN SG1010 ON D4_COD = G1_COD AND SG1010.D_E_L_E_T_<>'*'

		INNER JOIN SB1010 GR2 ON GR2.B1_COD = G1_COMP AND GR2.D_E_L_E_T_ <> '*'

		WHERE 
			GR1.B1_GRUPO = '032N' 
			AND LEFT (D4_OP, LEN(D4_OP)-5) IN (OP) 
			AND G1_COMP NOT LIKE 'B%'
			AND GR2.B1_GRUPO = '032'
)

SELECT 
	 ANO
	,MES
	,SUM(QNT_EMP) AS PROD_MENSAL
		
	FROM 
		BLOCOS_2024
	GROUP BY
		ANO
		, MES
	ORDER BY 
		ANO,			
		MES																																																																			
		
		

--PRODUÇÃO PREVISTA DE BLOCOS PARA 2024--------------------------------------------------------


SELECT SEMI_ACABADO,
	DESCRIÇÃO,
	SUM(QNT_TOTAL) AS PRODUÇÃO,
	ENTREGA,
	
	'P' AS PREVISTO

FROM(
	SELECT --A.PRODUTO
	 G1_COMP AS SEMI_ACABADO
	--, B1_GRUPO
	, a.DESCRIÇÃO
	--, NUMERO_OP
	, SUM(A.Qtd_Empenho)as QNT_TOTAL
	, CASE
		WHEN A.NUMERO_OP IN ('A00ZSQ', 'A00Z29', 'A00Z30', 'A00ZWG', 'A00ZWI', 'A00ZXA', 'A00ZXB', 'A00ZXC', 'A00ZXD', 
							'A00ZEI', 'A00ZUT', 'A00ZUU', 'A01184', 'A00ZWJ', 'A00ZWK') THEN '09'

		WHEN A.NUMERO_OP IN ('A00ZLL', 'A00ZLM', 'A00ZLN', 'A00ZXZ', 'A00ZY0', 'A00ZQ0', 'A00ZV3', 'A00ZYS', 'A00ZYT',
								'A00ZYU', 'A00ZY4', 'A00ZZD', 'A01166', 'A01167', 'A01174', 'A01175', 'A01177', 'A01171') THEN '10' 

		WHEN A.NUMERO_OP IN ('A00ZXE', 'A00ZXF', 'A00ZXG', 'A00ZXH', 'A00ZXI', 'A00ZXJ', 'A00ZXK', 'A00ZXL', 'A00ZXM',
								'A00ZXP', 'A00ZXQ','A00ZXR', 'A00ZXS', 'A00ZXT', 'A00ZXU', 'A01243', 'A01183') THEN '11'

		WHEN a.NUMERO_OP IN ( 'A00ZWW', 'A00ZWX', 'A00ZWY', 'A01051') THEN '12'
		ELSE '0'
		END ENTREGA
	FROM
		(SELECT						--
			D4_COD AS Produto,
			B1.B1_DESC AS DESCRIÇÃO,
			D4_LOCAL AS Armazem,
			LEFT (D4_OP, LEN(D4_OP)-5) AS NUMERO_OP,
			D4_DATA AS DT_Empenho,
			D4_QTDEORI AS Qtd_Empenho,
			D4_PRODUTO AS Produto_Pai,
			--B2.B1_DESC AS DESCRIÇÃO_PAI,
			B1.B1_GRUPO AS Grupo
			FROM SD4010 D 

			INNER JOIN SB1010 B2 ON D4_PRODUTO = B1_COD

			INNER JOIN SB1010 B1 ON	D4_COD = B1.B1_COD

			WHERE B1.B1_GRUPO = '032N' AND
				LEFT (D4_OP, LEN(D4_OP)-5) IN
					( 'A00ZSQ', 'A00Z29', 'A00Z30', 'A00ZWG', 'A00ZWI', 'A00ZXA', 'A00ZXB', 'A00ZXC', 'A00ZXD','A00ZEI', 'A00ZUT', 'A00ZUU',
					'A01184', 'A00ZWJ', 'A00ZWK''A00ZLL', 'A00ZLM', 'A00ZLN', 'A00ZXZ', 'A00ZY0', 'A00ZQ0', 'A00ZV3', 'A00ZYS', 'A00ZYT', 
					'A00ZYU', 'A00ZY4', 'A00ZZD','A01166', 'A01167', 'A01174', 'A01175', 'A01177', 'A01171', 'A00ZXE', 'A00ZXF', 'A00ZXG', 
					'A00ZXH', 'A00ZXI', 'A00ZXJ', 'A00ZXK', 'A00ZXL', 'A00ZXM', 'A00ZXP', 'A00ZXQ', 'A00ZXR', 'A00ZXS', 'A00ZXT', 'A00ZXU', 
					'A01243', 'A01183', 'A00ZWW', 'A00ZWX', 'A00ZWY', 'A01051')
				AND	b1.D_E_L_E_T_ <> '*') A
		INNER JOIN SG1010 ON Produto = G1_COD AND SG1010.D_E_L_E_T_<>'*'
		INNER JOIN SB1010 ON B1_COD = G1_COMP AND SB1010.D_E_L_E_T_<>'*'

	WHERE
		G1_COMP NOT LIKE 'B%'
		AND B1_GRUPO = '032'
	GROUP BY 
		
		G1_COMP,
		--a.Produto,
		a.DESCRIÇÃO, 
		a.NUMERO_OP)A 

	GROUP BY
		ENTREGA,
		SEMI_ACABADO,
		DESCRIÇÃO
		--B1_GRUPO

	--ORDER BY SUM(a.Qtd_Empenho) DESC



 --BLOCOS ENVIADOS PARA BENEFICIAMENTO 2024---------------------------------------------------


SELECT 
	C7_PRODUTO
	, SUM(C7_QUANT) AS PCS_BENEFICIADAS
	, MONTH(C7_EMISSAO) AS MES
	FROM SC7010
	WHERE
		C7_PRODUTO LIKE 'BFC%'
		AND C7_EMISSAO LIKE '2024%'
		AND C7_DESCRI LIKE 'BLOCO%'
		AND SC7010.D_E_L_E_T_ <>'*'
		AND C7_PRECO > 3
	GROUP BY 
		C7_PRODUTO,
		MONTH(C7_EMISSAO)


--TEMOS A QUANTIDADE EMPENHADA DURANTE O ANO, AGORA VAMOS COMPARAR COM A QUANTIDADE PRODUZIDA DURANTE O ANO, PARA VERIFICAR SE HÁ PRECISÃO------------

SELECT YEAR(H6_DTAPONT) AS ANO,
	MONTH(H6_DTAPONT)AS MES,
	DAY(H6_DTAPONT) AS DIA,
	H6_PRODUTO,
	B1_DESC,
	B1_GRUPO,
	SUM(H6_QTDPROD) AS QNT_PRODUZIDA,
	SUM((CONVERT(INT, left(H6_TEMPO,3))+CONVERT(float, right(H6_TEMPO,2))/60)) TEMP_PROD,
	SUM(H6_QTDPROD)/SUM((CONVERT(INT, left(H6_TEMPO,3))+CONVERT(float, right(H6_TEMPO,2))/60)) AS PCS_POR_HORA

	FROM SH6010 
	INNER JOIN SB1010 ON H6_PRODUTO = B1_COD
	WHERE 
		H6_RECURSO LIKE 'CNC%'
		AND H6_DTAPONT LIKE '2024%'
		AND SH6010.D_E_L_E_T_ <> '*'
		AND H6_MOTIVO =''
		AND B1_GRUPO LIKE '032%'
	GROUP BY
		YEAR(H6_DTAPONT),
		MONTH(H6_DTAPONT),
		DAY(H6_DTAPONT),
		H6_PRODUTO,
		B1_DESC,
		B1_GRUPO

-------------------------------------------

SELECT 
	H6_PRODUTO,
	B1_DESC,
	B1_GRUPO,
	*
	FROM SH6010 
	INNER JOIN SB1010 ON H6_PRODUTO = B1_COD
	--WHERE H6_OPERADO <> '000869'	AND 
	GROUP BY
		YEAR(H6_DTAPONT),
		MONTH(H6_DTAPONT),
		H6_PRODUTO,
		B1_DESC,
		B1_GRUPO


-- HORA MEDIA POR PEÇA NO SG1 E SG2-----------------------


SELECT 
	G2_PRODUTO
	, B1_DESC
	, G1_QUANT AS G1_TEMP_POR_PEÇA
	, ROUND(SUM(G2_TEMPAD / G2_LOTEPAD),3) AS G2_TEMP_POR_PEÇA
	FROM 
		SG2010
		INNER JOIN SB1010 ON G2_PRODUTO = B1_COD
		LEFT JOIN SG1010 ON G1_COD = G2_PRODUTO
	WHERE 
		SG2010.D_E_L_E_T_<>'*'
		AND SB1010.D_E_L_E_T_ <> '*'
		AND B1_GRUPO = '032'
		AND G2_RECURSO LIKE 'CNC%'
		AND G1_COMP LIKE 'MOD%'
		AND G1_FIM > '20240912'
	GROUP BY
		G2_PRODUTO
		, B1_DESC
		, G1_QUANT